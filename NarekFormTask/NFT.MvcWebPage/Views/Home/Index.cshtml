@model IEnumerable<NFT.MvcWebPage.Models.Employee>
@{
    ViewBag.Title = "Home Page";
}
@Styles.Render("~/Content/MainTable.css")

<h2>Employees</h2>
<button type="button" id="addButton">Add</button>
<button type="button" id="deleteButton">Delete</button>
<button type="button" id="cancelButton">Cancel</button>

<div id="helpTrigger" class="helpTrigger"></div>
<div id="helpContent" style="display:none"></div>

<table id="employees">
    <tr>
        <th>Id</th>
        <th>Name</th>
        <th>Surname</th>
        <th>Salary</th>
        <th>IsGettingBonus</th>
        <th>UniversityId</th>
        <th>Info</th>
    </tr>
    @{
        foreach (var employee in Model)
        {
            <tr id="@employee.Id">
                <td>@employee.Id</td>
                <td>@employee.Name</td>
                <td>@employee.Surname</td>
                <td>@employee.Salary</td>
                <td>@employee.IsGettingBonus</td>
                <td>@employee.UniversityId</td>
                <td>@employee.Info</td>
                <td class="chbox"><input type="checkbox" name="deleteBox" value="" /></td>
            </tr>
        }
    }
</table>

@section scripts
{
    <script>
        //alert("mtanq script");
        var ids = [];

        $(".chbox").hide();
        $("#cancelButton").hide();
        $("#addButton").on("click", addTextBoxes);
        $("#deleteButton").on("click", deleteToConfirm);
        $("#cancelButton").on("click", function () { saveToAdd(); confirmToDelete();});
        $(":checkbox").on("change", function () {
            if (this.checked) {
                //ids.push($(this).parent().parent().children().first().text());
                ids.push($(this).closest("tr").attr("id"));
            } else {
                var index = ids.indexOf($(this).closest("tr").attr("id"));
                if (index != -1) ids.splice(index, 1);
            }
        });
        //$("input[type='checkbox']").on("uncheck", function () {

        //});

        function saveEmployee() {
                $.ajax({
                    url: '@Url.Action("AddEmployee")',
                    dataType: "json",
                    type: "POST",
                    data: { toAdd: [$("#addName").val(), $("#addSurname").val(), $("#addSalary").val(), $("#addIsBonus").is(":checked") ? true : false, $("#addUnivId").val(), $("#addInfo").val(),] },
                    success: function (result) {
                        //$("#helpContent").empty().append(result);
                        //$("#helpContent").show();
                        //$("#addButton").removeClass("helpTrigger").addClass("closeTrigger");
                        console.log('<tr id="' + result.data + '"><td>' + result.data + '</td><td>' + $("#addName").val() + '</td><td>' + $("#addSurname").val() + '</td><td>' + $("#addIsBonus").is(":checked") ? true : false + '</td><td>' + $("#addUnivId").val() + '</td><td>' + $("#addInfo").val() + '</td></tr>');
                        //$('#employees tr:last').after('<tr id="' + result + '"><td>' + result + '</td><td>' + $("#addName").val() + '</td><td>' + $("#addSurname").val() + '</td><td>' + $("#addIsBonus").is(":checked") ? true : false + '</td><td>' + $("#addUnivId").val() + '</td><td>' + $("#addInfo").val() +'</td></tr>');
                        saveToAdd();
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert(xhr.statusText);
                        alert(thrownError);
                    }
                });
        }

        function addTextBoxes() {
            //$("#helpContent").empty();
            //$("#helpContent").hide();
            //$("#helpTrigger").removeClass("closeTrigger").addClass("helpTrigger");
            $('#employees tr:last').after("<tr id=\"lastTr\"><td></td><td><input type=\"text\" id=\"addName\"/></td><td><input type=\"text\" id=\"addSurname\"/></td><td><input type=\"text\" id=\"addSalary\"/></td><td><input type=\"checkbox\" id=\"addIsBonus\"/></td><td><input type=\"number\" id=\"addUnivId\"/></td><td><input type=\"text\" id=\"addInfo\"/></td></tr>");
            $("#addButton").text("Save");
            $("#cancelButton").show();
            $("#addButton").unbind("click");
            $("#addButton").on("click", saveEmployee);
        }

        function saveToAdd() {
            $("#addButton").unbind("click");
            $("#addButton").click(addTextBoxes);
            $("#addButton").text("Add");
            $("#cancelButton").hide();
            $("#lastTr").remove();
        }

        function deleteToConfirm() {
            $(".chbox").show();
            $("#cancelButton").show();
            $("#deleteButton").text("Confirm");
            $("#deleteButton").unbind("click");
            $("#deleteButton").on("click",submitDelete);
        }

        function submitDelete() {
            if (ids != undefined && ids.length > 0) {
                $.ajax({
                    url: '@Url.Action("RemoveEmployeesByIds")',
                    data: { 'ids': ids },
                    type: "POST",
                    //dataType: "json",
                    success: function (result, status, jqXHR) {
                        for (var i = 0; i < ids.length; i++) {
                            $("#" + ids[i].toString()).remove();
                        }
                        uncheckChecked();
                        confirmToDelete();
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert(xhr.statusText);
                        alert(thrownError);
                    }
                });
            }
        }

        function uncheckChecked() {
            $("input[type='checkbox']").prop('checked', false);
            ids = [];
        }

        function checkUncheckAll() {
            $('#checkall').click(function () {
                var checked = $(this).prop('checked');
                $("input[type='checkbox']").prop('checked', checked);
            });
        }

        function confirmToDelete() {
            $(".chbox").hide();
            $("#cancelButton").hide();
            $("#deleteButton").text("Delete");
            $("#deleteButton").unbind("click");
            $("#deleteButton").on("click", deleteToConfirm);
        }

    </script>
}
